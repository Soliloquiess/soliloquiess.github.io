---
title: "[자바]소켓 멀티 채팅"
layout: post
subtitle: Java
date: "2021-11-23 07:52:51 +0900"

categories: study
tags: Java
# layout: post
# title:  WebFrontEnd
# subtitle:   "시작하기"
# categories: study
# tags: java
comments: true
---


소켓은 아이피 정보와 포트 정보(포트 번호)로 이뤄진 클래스
PC와 PC가 통신 하려면 소켓을 통해 (IO) 한다.

소켓은 데이터 주고받아야 해서 각 소켓은 상대방의 정보를 알아야 한다.


### 1. Socket(소켓)이 만들어지는 과정(TCP 3-way HandShake)
![20220319_190052](/assets/20220319_190052.png)

서버쪽엔 소켓 말고 서버소켓이 만들어짐(별개의 개념)
서버 소켓은 통신 하기 위한 소켓이 아니라 서버쪽에만 만들어짐.
클라이언트로 부터 접속 받기 위해서만 만들어짐.

서버 소켓 만드려면 클라이언트가 접속하도록 포트 번호를 만들어줘야 된다.

서버소켓은 클라이언트가 접속하기 위해 출입문 만들어짐.

1. 서버가 9000번 포트 열면 대기
2. 클라이언트가 접속하려면?
3. ***클라가 서버 갈 때 자기 정보를 가지고 간다***
4. 그리고 포트가 열려서 나가야 한다.(클라이언트도 문 열고 나감)



### 2. JAVA에서 Socket(소켓) 만들기(ServerSocket, Socket, import java.net.*)
![20220319_190103](/assets/20220319_190103.png)

클라이언트도 내부적으로 포트 여는데 몇번이 열릴지는 모름

자기 정보가 접속 안하면 전혀 알 수 없다.

tpc,ip는 클라가 서버 접속시 그 정보를 반드시 자기 정보를 넘겨주게 된다. 그게 ip 정보, 포트 번호이다.

접속 시도시 자신의 정보도 넘어간다 이게 중요.

----

클라에 접속 되면 식별하는데 어디서 온지, 몇번 포트 열고 오는지 식별하는데 이 서버 소켓은 클라이언트의 접속을 대기함.

서버 소켓이 클라이언트 식별하면 하나의 다른 쪽으로 열고 소켓 하나 만듬(서버소켓은 통신 용이 아님, 통신하기 위해 다른 포트로 연결)

9001번도 몇번 포트 열릴지 모름.

클라이언트 식별하고 통신하기 위해 다른 쪽 포트 열어줌.
이걸 바인딩(연결시켜준다)이라고 한다.


클라 식별하고 바인딩 하는게 2번쨰고 소켓이 완전히 만들어짐.
이 소켓은 데이터 통신이 가능해짐.
이 소켓은 클라이언트와 통신이 가능해지고 이 소켓은 클라이언트 정보를 알아야 하므로 클라이언트 정보가 들어간다

***서버에서 만들어진 소켓은 클라이언트 정보를 알고있다.***

서버에서 소켓 만들어지면, 넘겨주는데 서버의 정보를 넘겨준다.

서버의 정보를 클라에 줘야 클라도 그걸 통해 서버에 통신 가능.

서버 소켓 만들어지고 정보 주면 이 클라이언트도 소켓 완성.

서버 정보 알고 있어야 되는데 이 정보를 알고 있어야 한다.

이게 3 핸드 쉐이킹의 기본(3-way HandShake)


***소켓과 클라는 상대방의 정보를 알고 3핸드 쉐이킹을 한다***

만약 클라가 하나 더있으면? 똑같이 하나 더한다.

소켓 정보 알고 클라 정보를 넘겨주며 서버 정보를 받아오고 통신을 한다.

----


자바 소켓에는 서버소켓, 소켓이 있고 쓰기 위해서는 import java.net을 사용해야 한다.


1. 서버 소켓 만들어서 대기할 수 있는 9000번 포트를 만들어준다.
2. 서버 입장에서 포트 열리면 접속했는지 어케 암?->누구는 계속 체크한다. 이게 서버소켓의 accept메소드가 (서버에 대기, 이게 중요)  블로킹 하면서 접속을 대기(블로킹 메서드라고도 한다)
3. 접속하게 되면 식별한다.(클라이언트에 정보가 넘어오는데 이게 클라이언트 식별하고 정상적인 요청이면 수락, 아니면 거부)
4. 통신 하도록 다른 포트를 열어서 바인딩 한다.
5. 소켓은 클라이언트의 정보가 들어간다.
6. 서버쪽도 클라이언트에 넘겨줘야 클라이언트도 서버에 정보를 전달이 가능하다.


근데 서버입장에서 클라이언트가 여러개 오면?
소켓 관리를 리스트든 해쉬 맵이든 서버에는 배열적인 요소 가지고 있다가 배열적인 요소에 소켓 담아둠.
이 소켓 정보는 1,2번 이런식으로 저장해야한다(당연, 1:1일때는 필요 없겠지만.)

----



### 3. Socket을 이용한 Multi-Chatting 만들기

![20220319_191054](/assets/20220319_191054.png)

서버에는 HashMap이 있는데 키에는 박, 값에는 output이 들어감

서버입장에선 입장하면 스레드 만듬. 이 해쉬맵 정보를 읽어와서 열거형으로 반복문 써서 이 모든 해쉬맵을 브로드캐스팅(방송)해서 쫙 뿌림.

모든 클라이언트한테 다 뿌려주게 된다.

클라이언트는 센더를 통해 보낸다. 그리고 소켓쪽에 네임을 통해 보내고
리시버는 받을 떄 필요. 서버에서 요청을 받아오면 출력하게 된다.
