---
title: "[C] C lang 가변 인자 함수"
layout: post
subtitle: C
date: "2022-03-16-08:42:51 +0900"

categories: study
tags: C
# layout: post
# title:  WebFrontEnd
# subtitle:   "시작하기"
# categories: study
# tags: java
comments: true
---

### 가변 인자 함수

#### printf() 같은 함수는 어떻게 만드나.

- printf() 또는 scanf()에 대해 의구심

  - 얘들은 왜 출력/입력할 데이터를 자료형 한개나 그 이상을 넣을 수 있는건가?

  - 심지어는 그 자료형이 달라도 됨.

![20221113_170707](https://user-images.githubusercontent.com/37941513/201512195-1644dd74-3b3a-429b-a33a-b185fd8936ea.png)


#### 가변인자 함수 
![20221114_003319](https://user-images.githubusercontent.com/37941513/201530610-5023d098-def5-40aa-a191-51db0875a435.png)


- 정해지지 않은 수의 매개변수(가변인자)를 허용하는 함수
  - 2개 넣어도 된다. 그 이상도 가능

- 반드시 최소 한개의 정해진 자료형의 매개변수가 필요
- 가변인자는 ...로 표현


#### 가변 인자 함수는 언제 쓰나

![20221114_005256](https://user-images.githubusercontent.com/37941513/201531230-2652f96d-bb97-477c-84bc-7df1e2438bad.png)

- 아주 많이 사용되진 않지만 가끔은 쓴다.

![20221114_005405](https://user-images.githubusercontent.com/37941513/201531228-30229d6e-73b4-497d-b729-37090671ab97.png)

- 반환명, 함수명 까지는 동일
- 첫번째 매개변수는 일반적인 매개변수를 넣어야 한다.
- 그 다음 어떤 데이터의 형인 매개변수라도 받을 수 있는 가변변자라고 해준다.
- va_list는 가변인자 목록이라 그러고 얘를 사용하려면 stdarg.h를 인클루드 해줘야 한다.
- 이 매개변수를 va_start에 넣어주고 변수 ap와 매개변수 count를 va_start의 매개변수로 넣어준다.


![20221114_010757](https://user-images.githubusercontent.com/37941513/201531752-e9b40562-602d-41a7-b45d-bfa568d3e1f3.png)


처음 보는 건 이 4개다.

### va_로 시작하는 매크로 함수들


#### va_list


![20221114_011311](https://user-images.githubusercontent.com/37941513/201532265-fb647376-1638-440f-a7c8-37c4cbfe82af.png)

- 가변 인자 목록
- va_start(), va_arg(), va_end() 매크로 함수를 사용 할 떄 필요한 정보가 포함
- 명시되지 않은 자료형(구현마다 다름)

```
va_list ap
```

#### va_start()


![20221114_011438](https://user-images.githubusercontent.com/37941513/201532263-104d66bb-380f-4be6-b78e-6e1533f4cce3.png)

- 매크로 함수
- 함수 매개변수로 들어온 가변 인자들에 접근 하기 전에 반드시 호출해야 한다.

- va_list에 필요한 초기화를 수행
  - 특히 가변 인자가 스택 메모리의 어디서 부터 실행하는 지 찾아냄
  - 그래서 두번째 매개 변수가 필요

#### va_end()

![20221114_012928](https://user-images.githubusercontent.com/37941513/201532799-26ecb461-4949-434b-92e2-3921c4a3c940.png)


- 매크로 함수
- 함수 매개변수로 들어온 가변인자들에 대한 접근이 끝나고 반드시 호출해야 함
- 사용한 가변인자 목록을정리함
  - 더 이상 가변 인자 목록을 사용하 수 없도록 가변 인자 목록의 값을 수정함 


![20221114_013120](https://user-images.githubusercontent.com/37941513/201532801-bfd7fdf3-60bd-4441-9780-e5da7fc554a5.png)




#### va_arg()

![20221114_013342](https://user-images.githubusercontent.com/37941513/201532908-032aed56-66ee-4f7e-8b4f-bf0769f57bfd.png)


- 매크로 함수
- 가변 인자 목록으로 부터 다음 가변인자를 가져옴
- 가져올 가변 인자의 자료형은 두번쨰 매개변수로 알려줌
- 예전 표준상의 문제로 가변 인자의 목록의 기본 자료형 인자들은 다음과 같이 승격(promotion) 됨

  - 모든 정수형은 int로
  - 모든 부동 소수점은 double로

- 따라서 매개변수에는 int나 double을 쓸 것


구조체를 넣어줄 수도 있고 실제 va_arg에서 이런식으로 불러오는 법도 있다.
그리고 구조체도 다른 변수형이랑 똑같이 돈다

#### va_args()는 어떻게 인자목록에서 알아서 데이터를 읽어주나?

![20221114_015507](https://user-images.githubusercontent.com/37941513/201533895-3ba4fb7a-2ce5-46c8-813c-cf079d87d50a.png)


- C에서 실행중에 자동으로 자료형을 판단하는 기능이 없다
- 따라서 컴파일러가 이와 비슷한 코드를 컴파일러 하게 해줘야 한다.

- 데이터 블록을 일단 가져온다. 스택메모리 어딘가를 가리킨다고 가정. 그럼 거기서 int 하나 읽어오고 얘는 void형이므로 int로 캐스팅 한 뒤 그 값을 읽어옴 그럼 이제 실제 값임. 컴파일러가 읽을 수 있어야 됨.


- 컴파일러가 컴파일 하게 미리 코드를 만든다.
  - 전처리기

#### va_arg()는 매크로 함수


![20221114_015432](https://user-images.githubusercontent.com/37941513/201533903-48386b6f-5761-40a2-a5b5-fa5407516200.png)


- 함수처럼 보이나 엄밀한 의미의 함수는 아니다.
  - 스택 프레임 만들지도, 
  - 매개변수 전달하지도
  - 함수 주소로 점프하지도 않음

- 그 대신 전처리기가 매크로 함수의 구현코드로 대체시켜줌

<br>

--------


### 가변 인자 함수가 인자를 읽어오는 방법

#### 어떻게 다른 수의 매개변수를 스택에 넣나

- 어떤 함수 호출 할 떄매다 순서대로 스택에 넣어줌.


![20221114_020240](https://user-images.githubusercontent.com/37941513/201534511-4dad871d-a8f5-46d8-a925-ee44b06a8ce4.png)



몇개의 매개변수가 오는지 모르지만
호출자는 매개변수 몇개를 스택에 넣어야 하는지 분명히 안다.그래서 크게 문제가 아님. 근데 호출을 받는 애 , 가변인자 함수 내부에서 나한테 몇개가 들어온 지 모르기 때문에 가져다 쓰는게 문제일 뿐
![20221114_021012](https://user-images.githubusercontent.com/37941513/201534624-08b81f52-8dd8-4d72-bc27-2eb077eb48a8.png)

![20221114_020959](https://user-images.githubusercontent.com/37941513/201534625-773bb593-8d45-4736-9db6-d80fe763b9ca.png)


- 정확히 형이 정해진 매개변수. 가변인자가 아닌 매개변수. 이건 어디 있는지 안다. 스택 프레임 전에 있는 첫번째 매개변수 있는데서 가져오면 된다. 이런식


<br>

-------


#### 가변 인자 함수가 인자를 읽어오는 법


![20221114_022911](https://user-images.githubusercontent.com/37941513/201535597-79170e29-a2ed-426e-acaa-118bc22af3eb.png)

![20221114_023045](https://user-images.githubusercontent.com/37941513/201535579-a4191228-d666-47b4-a5c2-4c221fd5f628.png)
va_start하고 마지막 인자 가변인자가 아닌거 인자. 이걸 다르게 표현하면 가변인자가 시작하기 직전에 있는 매개변수. 이렇게 두번쨰 넣어주면 가변인자가 아닌 거에 제일 마지막 인자가 어느 위치에 있는지 안다. 그리고 데이터 형도 안다.

그러나 그거 다음이 가변인자 시작이구나 하고 메모리 주소를 계산해 줄수 있다.  

그래서 실행하면 이게 다음에 가변인자로 이제 시작해야할 메모리 주소는 이 count가 들어왔다. 그럼 count의 주소에서 이 count의 길이만큼 바이트 수를 옮기면 되겠구나.

이 count의 길이는 뭐지. sizeof(int) 왜냐면 int형이 들어온 걸 알기 떄문

실제 코드에선 sizeof(count)를 쓸 일이 많다. 그래서 실제 코드는 sizeof(int)대신 sizeof(count) 를 쓸 일이 더 많다.

이 주소를 char 포인터로 변환한 이유는(캐스팅 한 이유는)  그냥 sizeof(Int)를 더해버리면 count는 int였으니까 int 4개 들어갈 만큼 옮김.

그럼 바이트가 궁금한 것이므로 바이트로 이동하기 위해 이렇게 했다.
이제 ap.data가 이 주소를 가리키게 된다.
이걸 하는 순간 va_list형의 ap라는 변수는 가변인자가 시작하는 메모리 주소, 스택상의 메모리 주소에 주소를 가리킨다. 그 메모리 주소를 저장한다.
<br>

----


2 . 그럼 이제 매개변수를 읽는다. 가변인자 매개변수들

![20221114_022938](https://user-images.githubusercontent.com/37941513/201535585-0329233e-b652-4472-adf8-03d2a8e9632c.png)



![20221114_023125](https://user-images.githubusercontent.com/37941513/201535584-3d358fa0-a625-49fe-82cb-a9a7f5769ff8.png)



ap는 매개변수 가짐. 가변인자  매개변수가 첫번쨰 매개변수가 시작되는 그 위치 기억. 그럼 이걸 호출 시마다 한번에 하나씩 int 크기만큼 더해가면 된다. 그리고 읽을 위치를 변경

va_arg로 읽어온 걸 val에 대입한다.

<br>

----------


### 함수에서 매개변수로 가변 인자만 받을 수 있을까?


![20221114_121758](https://user-images.githubusercontent.com/37941513/201568428-954a5ac7-a09c-44fd-9e1d-e59b5727cb60.png)


#### 함수의 첫 번째 매개변수로 가변인자를 못 쓴다.

![20221115_003141](https://user-images.githubusercontent.com/37941513/201700136-e210dcbb-bc66-455d-bda3-40f21e6c7cc1.png)


- 가변 인자(...) 앞에 자료형이 특정된 매개변수가 반드시 있어야 한다.

- 가변 인자 뒤에 자료형이 정해진 매개변수가 있으면 안된다.
  - 함수가 정확히 어떤 오프에서 읽어와야 하는지 컴파일 중에 특정 불가

  ![20221114_122656](https://user-images.githubusercontent.com/37941513/201568691-7e8b0c5c-7c45-4467-8105-01d1946b02b4.png)

- 즉, 가변인자 아닌 것을 순서대로 읽음.
- 그 뒤, 가변인자는 va_arg()가 시키는 대로 하나씩 주소를 늘려가며 읽는 것.

- 가변인자 시작하기 전 바로 전 마지막 인자. 그걸 넣어 줘야지만 가변인자가 어디서 시작할 지 알 수 있다

- 똑같이 가변인자가 중간네 나오고 또 인자 받는다? 그럼 가변인자가 어디 들어갈 지 모르는 데 어떻게 스택에 들어가는지 아는가.

- 그래서 가변인자 아닌 거 다 먼저 인자로 받고 그 뒤에 가변인자가 올 수 밖에 없다.

  - 그 이유는 va_start같은 게 메모리 위치를 특정해야 되기 때문이다.


#### 이유?

1 . 가변인자가 몇 개인지 가변 인자 함수는 모른다

- 실제 가변인자가 몇개 들어온 지 호출된 함수는 모른다
- 그래서 앞의 예에선 매개변수 count로 제어

![20221114_131734](https://user-images.githubusercontent.com/37941513/201574040-63d9dc41-9a3b-4a67-896f-3cdc6033bd99.png)




단, 스택 메모리 어느 위치부터 가변인자가 시작 되는지는 안다.


<br>

-------

#### 2. 가변 인자 자료형을 가진 인자 함수는 모름


![20221115_004607](https://user-images.githubusercontent.com/37941513/201703401-af492b9a-7918-4708-95dd-bc9208faea24.png)

- 어떤 형의 가변 인자인지는 실행 중 결정
- 그래서 가변 인자 함수 자체는 스택의 어떤형으로 읽어야 할지 모름
- 따라서 , 정해진 자료형으로 넘겨주는 매개변수로부터 알아야 함


![20221115_004645](https://user-images.githubusercontent.com/37941513/201704833-2fdd3ac1-5408-4f4d-aeba-7579fc88be4b.png)



![20221115_005630](https://user-images.githubusercontent.com/37941513/201705813-bee8b58c-44c6-4988-aca4-ac3f32c745c6.png)
![20221115_005645](https://user-images.githubusercontent.com/37941513/201705890-f11814cc-fc5a-4df8-b5ca-fc626082d8ba.png)

#### 데이터를 잘못 읽으면?

![20221115_005756](https://user-images.githubusercontent.com/37941513/201706188-dc24edf7-77af-4ec5-9aa4-84b142b2d140.png)

<br>

------

###  오류처리


#### C에서의 오류처리

- C 언어는 예외(exception)를 지원하지 않는다.

- 그럼 어떻게 예외처리?


#### 예외처리가 언제나 좋은 것은 아니다.

![20221115_122123](https://user-images.githubusercontent.com/37941513/201818936-ac1855b0-e75a-4796-90ab-7632ead2d3df.png)



- 예외처리는 인간이 완벽히 하게엔 거의 불가능
- 그리고 예외처리 기능이 존재하는 언어는 오히려 프로그래머를 게으르게 하기도 한다.


<br>

------


#### 일반적인 사람들의 사고방식

![20221115_122123](https://user-images.githubusercontent.com/37941513/201818936-ac1855b0-e75a-4796-90ab-7632ead2d3df.png)


- 여러 단계 일을 설계시 최상의 경우(happy path)만 고려
- 내가 작성하는 코드 한줄 한줄이 잘못 될수 있다는 생각 안하고 기능 우선 쭉쭉 작성함
  - 그런다고 크래시 나지 않으므로 모른척 하는 경우도 대다수

- 그래서 실제로는 버그가 많으나 어떻게든 동작하는 프로그램이 나오기도 함.

